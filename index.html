<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Analytics - Google Ads</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Arial, sans-serif;
      background: #f8fafc;
      color: #334155;
      min-height: 100vh;
      display: flex;
      width: 100%;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: #1e293b;
      padding: 24px 0;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .logo {
      padding: 0 24px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 24px;
    }

    .logo h1 {
      color: white;
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-menu {
      padding: 0 16px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .nav-item:hover,
    .nav-item.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .nav-item i {
      width: 20px;
      margin-right: 12px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 24px 32px;
      width: calc(100% - 280px);
      overflow-x: hidden;
    }

    /* Common Card Style */
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e2e8f0;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      padding: 32px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: #64748b;
      font-size: 16px;
      margin-bottom: 24px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 20px;
      align-items: end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .input-field {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    .input-field:focus {
      outline: none;
      border-color: #1e293b;
    }

    .period-inputs {
      display: flex;
      gap: 16px;
    }

    .btn-primary {
      background: #1e293b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      height: fit-content;
    }

    .btn-primary:hover {
      background: #334155;
    }

    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 60px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #1e293b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      color: #64748b;
      font-size: 16px;
      font-weight: 500;
    }

    /* Error */
    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 20px 24px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 4px solid #dc2626;
      display: none;
      font-weight: 500;
      white-space: pre-line;
    }

    .error-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .error-content {
      font-size: 14px;
      line-height: 1.6;
    }

    /* Results */
    .results {
      display: none;
    }

    /* Status Banner */
    .status-banner {
      background: #1e293b;
      color: white;
      padding: 20px 32px;
      margin-bottom: 32px;
      border-radius: 12px;
      display: none;
    }

    .status-banner.show {
      display: block;
    }

    .status-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-main {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .status-info h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
      font-weight: 700;
    }

    .status-info p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .article-name {
      font-size: 20px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      border-radius: 8px;
    }

    /* Section Titles */
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #e2e8f0;
      position: relative;
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .metric-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-icon {
      width: 40px;
      height: 40px;
      background: #f1f5f9;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      font-size: 18px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .metric-subtitle {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 500;
    }

    .metric-additional {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #e2e8f0;
    }

    /* Efficiency Zones */
    .efficiency-zones {
      min-height: 240px;
    }

    .current-zone-display {
      margin-top: 8px;
      text-align: center;
    }

    .zone-percentage {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 20px;
      border: 2px solid;
      margin-bottom: 12px;
    }

    .zones-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .zone-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      border-left: 3px solid;
      text-align: center;
    }

    .zone-red {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: #ef4444;
      color: #dc2626;
    }

    .zone-pink {
      background: rgba(236, 72, 153, 0.1);
      border-left-color: #ec4899;
      color: #be185d;
    }

    .zone-gold {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: #f59e0b;
      color: #d97706;
    }

    .zone-green {
      background: rgba(34, 197, 94, 0.1);
      border-left-color: #22c55e;
      color: #16a34a;
    }

    .zone-label {
      font-size: 11px;
      opacity: 0.8;
    }

    .zone-value {
      font-weight: 700;
      font-size: 13px;
    }

    /* Chart Section */
    .chart-section {
      padding: 32px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }

    .chart-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-container {
      height: 500px;
      position: relative;
    }

    /* Table Section */
    .table-section {
      padding: 24px;
      overflow-x: hidden;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      max-width: 100%;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
    }

    .data-table th {
      background: #f8fafc;
      color: #374151;
      font-weight: 600;
      padding: 16px 12px;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
      white-space: nowrap;
    }

    .data-table th:first-child {
      position: sticky;
      left: 0;
      background: #f8fafc;
      min-width: 220px;
    }

    .data-table td {
      padding: 12px;
      border: 2px solid #e3e3e3;
      vertical-align: top;
      max-width: 200px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .data-table td.url-cell {
      max-width: 400px;
      white-space: normal;
      line-height: 1.4;
      word-break: break-all;
    }

    .data-table td:first-child {
      position: sticky;
      left: 0;
      background: inherit;
      min-width: 220px;
      text-align: left !important;
    }

    .data-table tbody tr:hover {
      background: #f8fafc;
    }

    .data-table .metric-row {
      font-weight: 600;
      color: #374151;
      background: #fafafa !important;
    }

    .clickable-url {
      color: #1a73e8;
      text-decoration: underline;
      padding: 2px 4px;
      border-radius: 4px;
      display: inline-block;
      margin: 1px 0;
      background: rgba(26, 115, 232, 0.05);
      font-size: 12px;
      word-break: break-all;
      line-height: 1.3;
    }

    .clickable-url:hover {
      background: rgba(26, 115, 232, 0.1);
    }

    /* Rating Colors */
    .rating-A {
      background: #dcfce7 !important;
      color: #166534 !important;
      font-weight: 600;
    }

    .rating-B {
      background: #fef3c7 !important;
      color: #a16207 !important;
      font-weight: 600;
    }

    .rating-C {
      background: #fed7aa !important;
      color: #c2410c !important;
      font-weight: 600;
    }

    .rating-D {
      background: #fecaca !important;
      color: #dc2626 !important;
      font-weight: 600;
    }

    /* Buyer Groups Structure */
    .buyer-group-main-section {
      margin-bottom: 48px;
    }

    .buyer-group-main-title {
      font-size: 32px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .buyer-group-main-subtitle {
      color: #64748b;
      font-size: 18px;
      margin-bottom: 32px;
      font-weight: 500;
    }

    /* Buyer Header */
    .buyer-header-enhanced {
      background: #059669;
      color: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      cursor: pointer;
    }

    .buyer-header-enhanced:hover {
      background: #047857;
    }

    .buyer-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 24px;
    }

    .buyer-main-info h2 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .buyer-main-info p {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
    }

    .buyer-toggle-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .buyer-stats-preview {
      background: rgba(255, 255, 255, 0.15);
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .buyer-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 12px;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
    }

    .buyer-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Buyer Content Area */
    .buyer-content-area {
      background: #f8fafc;
      border-radius: 12px;
      margin-bottom: 32px;
      overflow: hidden;
      max-height: 10000px;
      opacity: 1;
    }

    .buyer-content-area.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
      padding: 0;
    }

    /* Buyer Sections */
    .buyer-metrics-section,
    .buyer-chart-section,
    .buyer-groups-section {
      padding: 32px;
      border-bottom: 1px solid #e2e8f0;
    }

    .buyer-metrics-title,
    .buyer-chart-title,
    .buyer-groups-title {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .buyer-metrics-grid,
    .nested-group-metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .buyer-chart-container,
    .nested-group-chart-container {
      height: 400px;
      position: relative;
      background: white;
      border-radius: 12px;
      padding: 20px;
    }

    /* Nested Group */
    .nested-group-enhanced {
      background: white;
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .nested-group-header-enhanced {
      background: #1e293b;
      color: white;
      padding: 24px 32px;
      cursor: pointer;
    }

    .nested-group-header-enhanced:hover {
      background: #334155;
    }

    .nested-group-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 24px;
    }

    .nested-group-main-info h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nested-group-main-info p {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }

    .nested-group-content-enhanced {
      max-height: 5000px;
      opacity: 1;
    }

    .nested-group-content-enhanced.collapsed {
      max-height: 0;
      opacity: 0;
    }

    .nested-group-metrics,
    .nested-group-chart,
    .nested-group-table {
      padding: 24px 32px;
      border-bottom: 1px solid #f1f5f9;
    }

    .nested-group-metrics-title,
    .nested-group-chart-title,
    .nested-group-table-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nested-group-chart-container {
      height: 350px;
      background: #fafafa;
      border-radius: 8px;
      padding: 16px;
    }

    /* Enhanced Metric Cards */
    .metric-card-enhanced {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #f1f5f9;
      position: relative;
    }

    .metric-card-enhanced::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: #059669;
    }

    .metric-card-enhanced .metric-icon {
      width: 32px;
      height: 32px;
      background: #059669;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }

    .metric-card-enhanced .metric-value {
      font-size: 24px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 6px;
    }

    .metric-card-enhanced .metric-subtitle {
      font-size: 11px;
      color: #94a3b8;
      font-weight: 500;
    }

    /* Tooltips */
    .tooltip-container {
      position: relative;
      cursor: pointer;
    }

    .tooltip {
      visibility: hidden;
      opacity: 0;
      position: fixed;
      z-index: 9999;
      background: rgba(15, 23, 42, 0.98);
      color: white;
      padding: 20px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
      line-height: 1.5;
      white-space: pre-line;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      max-width: 90vw;
      max-height: 90vh;
      min-width: 300px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: scale(0.8);
      pointer-events: none;
    }

    .tooltip.show {
      visibility: visible;
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .tooltip.pinned {
      position: fixed;
      z-index: 10000;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(96, 165, 250, 0.5);
    }

    .tooltip::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      margin-left: -10px;
      border-width: 10px;
      border-style: solid;
      border-color: rgba(15, 23, 42, 0.98) transparent transparent transparent;
    }

    .tooltip.pinned::after {
      border-color: rgba(15, 23, 42, 0.98) transparent transparent transparent;
    }

    .tooltip-close {
      position: absolute;
      top: 8px;
      right: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .tooltip.pinned .tooltip-close {
      display: flex;
    }

    .tooltip-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .tooltip-title {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 8px;
      color: #60a5fa;
      border-bottom: 1px solid rgba(96, 165, 250, 0.3);
      padding-bottom: 4px;
    }

    .tooltip-item {
      display: block;
      padding: 2px 0;
      color: #e2e8f0;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω—É–ª–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ */
    .zero-spend-range,
    .zero-spend-single {
      background-color: #f3f4f6 !important;
      color: #9ca3af !important;
    }

    .zero-spend-range th,
    .zero-spend-single th {
      background-color: #e5e7eb !important;
      color: #6b7280 !important;
      text-align: center !important;
    }

    .zero-spend-range td,
    .zero-spend-single td {
      background-color: #f9fafb !important;
      color: #9ca3af !important;
      text-align: center !important;
    }

    .zero-spend-range,
    .zero-spend-single {
      text-align: center !important;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0;
        padding: 20px;
        width: 100%;
      }

      .controls-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 20px;
      }

      .card {
        padding: 16px;
      }

      .metrics-grid {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .main-content {
        padding: 16px;
      }
    }

    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .main-content {
        padding: 12px;
      }

      .card {
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <h1><i class="fas fa-chart-line"></i> Google Ads</h1>
    </div>
    <nav class="nav-menu">
      <a href="#" class="nav-item active">
        <i class="fas fa-chart-bar"></i>
        –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header card">
      <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º</h1>
      <div class="header-subtitle">
        –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π Google Ads
      </div>

      <div class="controls-grid">
        <div class="input-group">
          <label class="input-label">–ê—Ä—Ç–∏–∫—É–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
          <input type="text" id="articleInput" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª..." />
        </div>

        <div class="period-inputs">
          <div class="input-group">
            <label class="input-label">–ü–µ—Ä–∏–æ–¥ —Å</label>
            <input type="date" id="periodStart" class="input-field" />
          </div>
          <div class="input-group">
            <label class="input-label">–ø–æ</label>
            <input type="date" id="periodEnd" class="input-field" />
          </div>
        </div>

        <button id="buildChart" class="btn-primary" onclick="buildChart()">
          <i class="fas fa-chart-line"></i> –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∞–Ω–∞–ª–∏–∑
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading card" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- Error -->
    <div class="error" id="error">
      <div class="error-title">
        <i class="fas fa-exclamation-triangle"></i>
        <span>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</span>
      </div>
      <div class="error-content" id="errorContent"></div>
    </div>

    <!-- Results -->
    <div class="results" id="results">
      <!-- Status Banner -->
      <div class="status-banner" id="statusBanner"></div>

      <!-- General Metrics -->
      <div class="metrics-section">
        <h2 class="section-title">
          <i class="fas fa-chart-pie"></i>
          –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        </h2>
        <div class="metrics-grid" id="generalMetrics"></div>
      </div>

      <!-- General Chart -->
      <div class="chart-section card">
        <div class="chart-header">
          <div class="chart-title">üìä –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="chart-container">
          <canvas id="generalChart"></canvas>
        </div>
      </div>

      <!-- General Table -->
      <div class="table-section card">
        <div class="chart-header">
          <div class="chart-title">–î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
        </div>
        <div class="table-container">
          <table class="data-table" id="generalTable"></table>
        </div>
      </div>

      <!-- Buyer-Group Hierarchy -->
      <div id="buyerGroupsContainer"></div>
    </div>
  </div>

  <script>
    let currentCharts = [];

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function formatTooltipContent(content, isUrls = false) {
      if (!content || content === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" || content.trim() === "") {
        return '<span class="tooltip-item" style="color: #94a3b8; font-style: italic;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';
      }

      const items = content.split("\n").filter((item) => item.trim() !== "");

      if (items.length === 0) {
        return '<span class="tooltip-item" style="color: #94a3b8; font-style: italic;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';
      }

      const uniqueItems = [...new Set(items)].sort();

      return uniqueItems
        .map((item, index) => {
          const trimmedItem = item.trim();

          if (
            isUrls &&
            (trimmedItem.startsWith("http://") ||
              trimmedItem.startsWith("https://"))
          ) {
            return `<a href="${trimmedItem}" target="_blank" class="tooltip-item" style="color: #60a5fa; text-decoration: underline;">${trimmedItem}</a>`;
          }

          return `<span class="tooltip-item">${escapeHtml(
            trimmedItem
          )}</span>`;
        })
        .join("\n");
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
    function makeUrlsClickable(text) {
      if (!text || text.trim() === "") return "";

      const urls = text.split("\n").filter((url) => url.trim() !== "");
      return urls
        .map((url) => {
          const cleanUrl = url.trim();
          if (
            cleanUrl.startsWith("http://") ||
            cleanUrl.startsWith("https://")
          ) {
            try {
              const urlObj = new URL(cleanUrl);
              const domain = urlObj.hostname.replace("www.", "");
              return `<a href="${cleanUrl}" target="_blank" class="clickable-url" title="${cleanUrl}">${domain}</a>`;
            } catch (e) {
              return `<a href="${cleanUrl}" target="_blank" class="clickable-url" title="${cleanUrl}">${cleanUrl}</a>`;
            }
          }
          return cleanUrl;
        })
        .join("<br>");
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    function toggleGroup(groupId) {
      const content = document.getElementById(groupId + "_content");
      const toggle = event.currentTarget.querySelector(".group-toggle i");

      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.classList.remove("fa-chevron-right");
        toggle.classList.add("fa-chevron-down");
        toggle.parentElement.classList.remove("collapsed");
      } else {
        content.classList.add("collapsed");
        toggle.classList.remove("fa-chevron-down");
        toggle.classList.add("fa-chevron-right");
        toggle.parentElement.classList.add("collapsed");
      }
    }

    function toggleBuyerGroup(buyerId) {
      const content = document.getElementById(buyerId + "_content");
      const toggle = event.currentTarget.querySelector(".buyer-toggle-btn i");

      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.classList.remove("fa-chevron-right");
        toggle.classList.add("fa-chevron-down");
        toggle.parentElement.classList.remove("collapsed");
      } else {
        content.classList.add("collapsed");
        toggle.classList.remove("fa-chevron-down");
        toggle.classList.add("fa-chevron-right");
        toggle.parentElement.classList.add("collapsed");
      }
    }

    function toggleNestedGroup(groupId) {
      const content = document.getElementById(groupId + "_content");
      const toggle = event.currentTarget.querySelector(".buyer-toggle-btn i");

      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.classList.remove("fa-chevron-right");
        toggle.classList.add("fa-chevron-down");
        toggle.parentElement.classList.remove("collapsed");
      } else {
        content.classList.add("collapsed");
        toggle.classList.remove("fa-chevron-down");
        toggle.classList.add("fa-chevron-right");
        toggle.parentElement.classList.add("collapsed");
      }
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
    window.toggleGroup = toggleGroup;
    window.toggleBuyerGroup = toggleBuyerGroup;
    window.toggleNestedGroup = toggleNestedGroup;

    function buildChart() {
      const article = document.getElementById("articleInput").value.trim();
      const periodStart = document.getElementById("periodStart").value;
      const periodEnd = document.getElementById("periodEnd").value;

      console.log(
        "üîç Input values - Article:",
        article,
        "Start:",
        periodStart,
        "End:",
        periodEnd
      );
      console.log(
        "üîç Period start element value:",
        document.getElementById("periodStart").value
      );
      console.log(
        "üîç Period end element value:",
        document.getElementById("periodEnd").value
      );

      if (!article) {
        showError(
          "üìù –í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞."
        );
        return;
      }

      showLoading(true);
      hideError();
      hideResults();

      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏
      console.log(
        "üóëÔ∏è –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:",
        currentCharts.length
      );
      currentCharts.forEach((chart, index) => {
        try {
          console.log(`üóëÔ∏è –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ ${index}:`, chart);
          if (chart && typeof chart.destroy === "function") {
            chart.destroy();
          }
        } catch (e) {
          console.log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:", e);
        }
      });
      currentCharts = [];

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö canvas —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      const allCanvases = document.querySelectorAll("canvas");
      console.log("üóëÔ∏è –ù–∞–π–¥–µ–Ω–æ canvas —ç–ª–µ–º–µ–Ω—Ç–æ–≤:", allCanvases.length);
      allCanvases.forEach((canvas, index) => {
        try {
          const chartInstance = Chart.getChart(canvas);
          if (chartInstance) {
            console.log(
              `üóëÔ∏è –£–Ω–∏—á—Ç–æ–∂–∞–µ–º Chart instance ${index}:`,
              chartInstance.id
            );
            chartInstance.destroy();
          }
        } catch (e) {
          console.log("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ canvas:", e);
        }
      });

      // –í—ã–∑—ã–≤–∞–µ–º Google Apps Script —Ñ—É–Ω–∫—Ü–∏—é
      try {
        console.log("üöÄ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∞—Ä—Ç–∏–∫—É–ª–∞:", article);
        console.log("üìÖ –ü–µ—Ä–∏–æ–¥:", periodStart, "–¥–æ", periodEnd);

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º-–∞—É—Ç
        let timeoutId = setTimeout(() => {
          console.error("‚è∞ –¢–∞–π–º-–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏");
          handleError(
            "‚è∞ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è!\n\n–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–Ω—è–ª–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –£–º–µ–Ω—å—à–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞\n‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–∑–∂–µ\n‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"
          );
        }, 120000); // 2 –º–∏–Ω—É—Ç—ã

        google.script.run
          .withSuccessHandler((result) => {
            clearTimeout(timeoutId);
            console.log("‚úÖ –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç:", result);
            handleSuccess(result);
          })
          .withFailureHandler((error) => {
            clearTimeout(timeoutId);
            console.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏:", error);
            handleError(error);
          })
          .buildChartForArticle(article, periodStart, periodEnd);
      } catch (e) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Google Apps Script:", e);
        handleError(
          "üîå Google Apps Script –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
        );
      }
    }

    function handleSuccess(data) {
      console.log("‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç Google Apps Script:", data);
      showLoading(false);
      displayResults(data);
    }

    function handleError(error) {
      console.error("‚ùå –û—à–∏–±–∫–∞ Google Apps Script:", error);
      showLoading(false);
      showError(error.toString());
    }

    function showLoading(show) {
      document.getElementById("loading").style.display = show
        ? "block"
        : "none";
      document.getElementById("buildChart").disabled = show;
    }

    function showError(message) {
      const errorDiv = document.getElementById("error");
      const errorContent = document.getElementById("errorContent");
      errorContent.textContent = message;
      errorDiv.style.display = "block";
    }

    function hideError() {
      document.getElementById("error").style.display = "none";
    }

    function hideResults() {
      document.getElementById("results").style.display = "none";
      document.getElementById("statusBanner").classList.remove("show");
    }

    function showResults() {
      document.getElementById("results").style.display = "block";
    }

    function displayResults(data) {
      console.log("üìä –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:", data);

      displayStatusBanner(data.article, data.generalMetrics);
      displayGeneralMetrics(data.generalMetrics);
      displayGeneralChart(data.article, data.generalData);
      displayGeneralTable(data.generalData);
      displayBuyerGroups(data.article, data.buyerGroupsData || {});

      showResults();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º tooltip –ø–æ—Å–ª–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      setupTooltipHandlers();
    }

    function displayStatusBanner(article, metrics) {
      const container = document.getElementById("statusBanner");
      container.innerHTML = `
        <div class="status-content">
          <div class="status-main">
            <div class="status-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <div class="status-info">
              <h3>–°—Ç–∞—Ç—É—Å –∞—Ä—Ç–∏–∫—É–ª–∞</h3>
              <p>${escapeHtml(metrics.status || "–ê–∫—Ç–∏–≤–Ω—ã–π")}</p>
            </div>
          </div>
          <div class="article-name">${escapeHtml(article)}</div>
        </div>
      `;
      container.classList.add("show");
    }

    function displayGeneralMetrics(metrics) {
      const container = document.getElementById("generalMetrics");

      let zoneValue, zoneBackground, zoneFontColor;

      if (
        typeof metrics.efficiencyZone === "object" &&
        metrics.efficiencyZone !== null
      ) {
        zoneValue = metrics.efficiencyZone.value || "--,--%";
        zoneBackground = metrics.efficiencyZone.backgroundColor || "#f3f3f3";
        zoneFontColor = metrics.efficiencyZone.fontColor || "#666666";
      } else {
        zoneValue = metrics.efficiencyZone || "--,--%";
        zoneBackground = "#f3f3f3";
        zoneFontColor = "#666666";
      }

      container.innerHTML = `
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">–¥–Ω–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–î–Ω–µ–π –≤ –Ω–æ—Ä–º–µ</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">‚â§ ${metrics.displayMaxCPL} CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–î–Ω–µ–π –Ω–∏–∂–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–π</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">‚â§ ${metrics.displayCPL_ROI_minus5
        } CPL</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">—Å—Ä–µ–¥–Ω–∏–π CR</div>
        </div>

        <div class="metric-card efficiency-zones">
          <div class="metric-header">
            <div class="metric-label">–ó–æ–Ω—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
            <div class="metric-icon"><i class="fas fa-bullseye"></i></div>
          </div>
          <div class="current-zone-display">
            <div class="zone-percentage" style="background-color: ${zoneBackground} !important; color: ${zoneFontColor} !important; border-color: ${zoneFontColor};">${zoneValue}</div>
            <div class="metric-subtitle">—Ç–µ–∫—É—â–∞—è –∑–æ–Ω–∞</div>
          </div>
          <div class="zones-grid">
            <div class="zone-item zone-red">
              <span class="zone-label">–ö—Ä–∞—Å–Ω–∞—è:</span>
              <span class="zone-value">${metrics.zoneAB || "-"}</span>
            </div>
            <div class="zone-item zone-pink">
              <span class="zone-label">–†–æ–∑–æ–≤–∞—è:</span>
              <span class="zone-value">${metrics.zoneAC || "-"}</span>
            </div>
            <div class="zone-item zone-gold">
              <span class="zone-label">–ó–æ–ª–æ—Ç–∞—è:</span>
              <span class="zone-value">${metrics.zoneAD || "-"}</span>
            </div>
            <div class="zone-item zone-green">
              <span class="zone-label">–ó–µ–ª–µ–Ω–∞—è:</span>
              <span class="zone-value">${metrics.zoneAE || "-"}</span>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–û—Å—Ç–∞—Ç–æ–∫</div>
            <div class="metric-icon"><i class="fas fa-boxes"></i></div>
          </div>
          <div class="metric-value">${escapeHtml(
          metrics.stock || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
        )}</div>
          <div class="metric-subtitle">–Ω–∞ —Å–∫–ª–∞–¥–µ</div>
          <div class="metric-additional">–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π: ${escapeHtml(
          metrics.stockDays || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
        )}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å</div>
            <div class="metric-icon"><i class="fas fa-calendar-alt"></i></div>
          </div>
          <div class="metric-value" style="font-size: 18px;">${escapeHtml(
          metrics.season || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        )}</div>
          <div class="metric-subtitle">–ø–µ—Ä–∏–æ–¥—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
            <div class="metric-icon"><i class="fas fa-tags"></i></div>
          </div>
          <div class="metric-value" style="font-size: 18px;">${escapeHtml(
          metrics.category || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"
        )}</div>
          <div class="metric-subtitle">—Ç–æ–≤–∞—Ä–Ω–∞—è –≥—Ä—É–ø–ø–∞</div>
        </div>
        
        <div class="metric-card tooltip-container" data-tooltip="groups">
          <div class="metric-header">
            <div class="metric-label">–í—Å–µ–≥–æ –≥—Ä—É–ø–ø</div>
            <div class="metric-icon"><i class="fas fa-layer-group"></i></div>
          </div>
          <div class="metric-value">${metrics.totalGroups}</div>
          <div class="metric-subtitle">–∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø</div>
          <div class="tooltip" id="tooltip-groups">
            <button class="tooltip-close" onclick="hideTooltip('tooltip-groups')">&times;</button>
            <div class="tooltip-title">üìÅ –ì—Ä—É–ø–ø—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π:</div>
            ${formatTooltipContent(metrics.groupNames || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")}
          </div>
        </div>

        <div class="metric-card tooltip-container" data-tooltip="buyers">
          <div class="metric-header">
            <div class="metric-label">–ë–∞–π–µ—Ä–æ–≤</div>
            <div class="metric-icon"><i class="fas fa-user-tie"></i></div>
          </div>
          <div class="metric-value">${metrics.totalBuyers}</div>
          <div class="metric-subtitle">–º–µ–¥–∏–∞–±–∞–π–µ—Ä–æ–≤</div>
          <div class="tooltip" id="tooltip-buyers">
            <button class="tooltip-close" onclick="hideTooltip('tooltip-buyers')">&times;</button>
            <div class="tooltip-title">üë§ –ú–µ–¥–∏–∞–±–∞–π–µ—Ä—ã:</div>
            ${formatTooltipContent(metrics.buyerNames || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")}
          </div>
        </div>

        <div class="metric-card tooltip-container" data-tooltip="accounts">
          <div class="metric-header">
            <div class="metric-label">–ê–∫–∫–∞—É–Ω—Ç–æ–≤</div>
            <div class="metric-icon"><i class="fas fa-users"></i></div>
          </div>
          <div class="metric-value">${metrics.totalAccounts}</div>
          <div class="metric-subtitle">—Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
          <div class="tooltip" id="tooltip-accounts">
            <button class="tooltip-close" onclick="hideTooltip('tooltip-accounts')">&times;</button>
            <div class="tooltip-title">üîë –†–µ–∫–ª–∞–º–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</div>
            ${formatTooltipContent(metrics.accountNames || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")}
          </div>
        </div>
        
        <div class="metric-card tooltip-container" data-tooltip="videos">
          <div class="metric-header">
            <div class="metric-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">–∫—Ä–µ–∞—Ç–∏–≤–æ–≤</div>
          <div class="tooltip" id="tooltip-videos">
            <button class="tooltip-close" onclick="hideTooltip('tooltip-videos')">&times;</button>
            <div class="tooltip-title">üé¨ –í–∏–¥–µ–æ –∫—Ä–µ–∞—Ç–∏–≤—ã:</div>
            ${formatTooltipContent(metrics.videoNames || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö")}
          </div>
        </div>
        
        <div class="metric-card tooltip-container" data-tooltip="sites">
          <div class="metric-header">
            <div class="metric-label">–õ–µ–Ω–¥–∏–Ω–≥–æ–≤</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">–ø–æ—Å–∞–¥–æ—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü</div>
          <div class="tooltip" id="tooltip-sites">
            <button class="tooltip-close" onclick="hideTooltip('tooltip-sites')">&times;</button>
            <div class="tooltip-title">üåê –ü–æ—Å–∞–¥–æ—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</div>
            ${formatTooltipContent(metrics.siteUrls || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", true)}
          </div>
        </div>
      `;
    }

    function displayGeneralChart(article, data) {
      console.log("üìä –°–æ–∑–¥–∞–µ–º –æ–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è:", article);

      const canvas = document.getElementById("generalChart");
      if (!canvas) {
        console.error("‚ùå General canvas –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
      }

      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        console.log(
          "üóëÔ∏è –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫:",
          existingChart.id
        );
        existingChart.destroy();
      }

      const ctx = canvas.getContext("2d");

      const gradientCPL = ctx.createLinearGradient(0, 0, 0, 400);
      gradientCPL.addColorStop(0, "rgba(99, 102, 241, 0.3)");
      gradientCPL.addColorStop(0.5, "rgba(99, 102, 241, 0.15)");
      gradientCPL.addColorStop(1, "rgba(99, 102, 241, 0.05)");

      const gradientLeads = ctx.createLinearGradient(0, 0, 0, 400);
      gradientLeads.addColorStop(0, "rgba(34, 197, 94, 0.25)");
      gradientLeads.addColorStop(1, "rgba(34, 197, 94, 0.05)");

      const gradientSpend = ctx.createLinearGradient(0, 0, 0, 400);
      gradientSpend.addColorStop(0, "rgba(251, 146, 60, 0.25)");
      gradientSpend.addColorStop(1, "rgba(251, 146, 60, 0.05)");

      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.dates,
          datasets: [
            {
              label: "CPL –∑–∞ –¥–µ–Ω—å",
              data: data.cplDay,
              borderColor: "#6366f1",
              backgroundColor: gradientCPL,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 8,
              pointBackgroundColor: "#6366f1",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 3,
              tension: 0,
              fill: true,
              order: 1,
            },
            {
              label: "–õ–∏–¥—ã –∑–∞ –¥–µ–Ω—å",
              data: data.leadsDay,
              borderColor: "#22c55e",
              backgroundColor: gradientLeads,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: "#22c55e",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: "y1",
              order: 2,
            },
            {
              label: "–†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å",
              data: data.spendDay,
              borderColor: "#fb923c",
              backgroundColor: gradientSpend,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: "#fb923c",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: "y1",
              order: 3,
            },
            {
              label: "Max CPL (–Ω–æ—Ä–º–∞)",
              data: data.maxCPL,
              borderColor: "#ef4444",
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderDash: [10, 5],
              tension: 0,
              order: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: "index",
          },
          plugins: {
            title: {
              display: true,
              text: `üìä –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π - ${article}`,
              font: {
                size: 22,
                weight: "bold",
              },
              color: "#1e293b",
            },
            legend: {
              display: true,
              position: "top",
            },
            tooltip: {
              backgroundColor: "rgba(15, 23, 42, 0.95)",
              titleColor: "#ffffff",
              bodyColor: "#e2e8f0",
              borderColor: "#475569",
              borderWidth: 1,
              cornerRadius: 12,
            },
          },
          scales: {
            x: {
              grid: {
                color: "rgba(148, 163, 184, 0.15)",
                drawBorder: false,
              },
              ticks: {
                color: "#64748b",
              },
            },
            y: {
              type: "linear",
              display: true,
              position: "left",
              title: {
                display: true,
                text: "üí∞ CPL ($)",
                color: "#374151",
              },
              grid: {
                color: "rgba(148, 163, 184, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#64748b",
                callback: function (value) {
                  return "$" + value.toFixed(1);
                },
              },
            },
            y1: {
              type: "linear",
              display: true,
              position: "right",
              title: {
                display: true,
                text: "üìà –õ–∏–¥—ã / –†–∞—Å—Ö–æ–¥",
                color: "#374151",
              },
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                color: "#64748b",
                callback: function (value) {
                  return Math.round(value);
                },
              },
            },
          },
        },
      });

      currentCharts.push(chart);
    }

    function displayGeneralTable(data) {
      console.log("üìã –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–±—â—É—é —Ç–∞–±–ª–∏—Ü—É —Å –¥–∞–Ω–Ω—ã–º–∏:", data);

      const table = document.getElementById("generalTable");
      const rows = [
        "–î–∞—Ç–∞",
        "–†–µ–π—Ç–∏–Ω–≥",
        "CPL (–¥–µ–Ω—å)",
        "–õ–∏–¥—ã (–¥–µ–Ω—å)",
        "–†–∞—Å—Ö–æ–¥ (–¥–µ–Ω—å)",
        "–ö–æ–Ω–≤–µ—Ä—Ç –≤ –¥–µ–Ω—å",
        "Max CPL (ROI +20%)",
        "CPL —Å —É—á—ë—Ç–æ–º —Å–±—Ä–æ—Å–æ–≤",
        "–ì—Ä—É–ø–ø—ã",
        "–ë–∞–π–µ—Ä—ã",
        "–ê–∫–∫–∞—É–Ω—Ç—ã",
        "–î–æ–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π",
        "CTR",
        "CPM",
        "CPC",
        "–î–æ–ª—è –ø–æ–∫–∞–∑–æ–≤",
        "–ü–æ–∫–∞–∑—ã",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",
        "–ö–ª–∏–∫–∏",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 25% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 50% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
        "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 75% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
        "–í–∏–¥–µ–æ—Ä–æ–ª–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é",
        "–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ",
        "URL —Å–∞–π—Ç–∞",
        "–®–∞–±–ª–æ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è",
      ];

      let html = "<tbody>";

      rows.forEach((rowName, index) => {
        html += `<tr><td class="metric-row" style="min-width: 220px;">${rowName}</td>`;
        for (let i = 0; i < data.dates.length; i++) {
          let value = "";
          let className = "";
          let cellStyle = "";

          switch (index) {
            case 0:
              value = data.dates[i];
              break;
            case 1:
              value = data.ratings[i];
              className = value ? `rating-${value}` : "";
              break;
            case 2:
              value = formatNumberWithZero(data.cplDay[i]);
              break;
            case 3:
              value = data.leadsDay[i];
              break;
            case 4:
              value = formatNumberWithZero(data.spendDay[i]);
              break;
            case 5:
              value = data.conversionDay ? data.conversionDay[i] : "";
              break;
            case 6:
              value = formatNumber(data.maxCPL[i]);
              break;
            case 7:
              value = formatNumberWithZero(data.cplCumulative[i]);
              if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                value += " " + data.cplCumulativeArrows[i];
              }
              if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                const color = data.cplCumulativeColors[i];
                if (color === "green") {
                  cellStyle =
                    "background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;";
                } else if (color === "red") {
                  cellStyle =
                    "background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;";
                } else if (color === "gray") {
                  cellStyle =
                    "background-color: #f3f4f6 !important; color: #6b7280 !important;";
                }
              }
              break;
            case 8:
              value = data.groups ? data.groups[i] : "";
              break;
            case 9:
              value = data.buyers ? data.buyers[i] : "";
              break;
            case 10:
              value = data.accounts ? data.accounts[i] : "";
              break;
            case 11:
              value = data.engagementRate ? data.engagementRate[i] : "";
              break;
            case 12:
              value = data.ctr ? data.ctr[i] : "";
              break;
            case 13:
              value = data.cpm ? data.cpm[i] : "";
              break;
            case 14:
              value = data.cpc ? data.cpc[i] : "";
              break;
            case 15:
              value = data.engagementView ? data.engagementView[i] : "";
              break;
            case 16:
              value = data.showed ? data.showed[i] : "";
              break;
            case 17:
              value = data.viewed ? data.viewed[i] : "";
              break;
            case 18:
              value = data.linkClicks ? data.linkClicks[i] : "";
              break;
            case 19:
              value = data.videoStart ? data.videoStart[i] : "";
              break;
            case 20:
              value = data.videoHalf ? data.videoHalf[i] : "";
              break;
            case 21:
              value = data.videoAlmost ? data.videoAlmost[i] : "";
              break;
            case 22:
              value = data.videoFull ? data.videoFull[i] : "";
              break;
            case 23:
              value = data.videoName ? data.videoName[i] : "";
              break;
            case 24:
              const urlValue = data.siteUrl ? data.siteUrl[i] : "";
              value = makeUrlsClickable(urlValue);
              break;
            case 25:
              value = data.trackTemplate ? data.trackTemplate[i] : "";
              break;
          }

          const colClass =
            data.columnClasses && data.columnClasses[i]
              ? data.columnClasses[i]
              : "normal-spend";
          className += ` ${colClass}`;

          // –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω—É–ª–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
          let additionalStyle = "";
          if (colClass.includes("zero-spend")) {
            additionalStyle = " text-align: center;";
          }

          if (index === 24) {
            html += `<td class="${className} url-cell" style="${cellStyle}${additionalStyle}">${value}</td>`;
          } else {
            html += `<td class="${className}" style="${cellStyle}${additionalStyle}">${escapeHtml(
              value
            )}</td>`;
          }
        }
        html += "</tr>";
      });

      html += "</tbody>";
      table.innerHTML = html;
    }

    function displayBuyerGroups(article, buyerGroupsData) {
      console.log("üå≤ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ä–µ–≤–æ–≤–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:", buyerGroupsData);
      console.log("üîç –°–ø–∏—Å–æ–∫ –±–∞–π–µ—Ä–æ–≤:", Object.keys(buyerGroupsData));
      Object.keys(buyerGroupsData).forEach((buyerName, index) => {
        console.log(
          `üîç –ë–∞–π–µ—Ä ${index}: "${buyerName}" (—Ç–∏–ø: ${typeof buyerName}, –¥–ª–∏–Ω–∞: ${buyerName.length
          })`
        );
      });

      const container = document.getElementById("buyerGroupsContainer");

      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏
      const existingCanvases = container.querySelectorAll("canvas");
      console.log(
        "üóëÔ∏è –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –Ω–∞–π–¥–µ–Ω–æ canvas:",
        existingCanvases.length
      );
      existingCanvases.forEach((canvas) => {
        const chartInstance = Chart.getChart(canvas);
        if (chartInstance) {
          console.log(
            "üóëÔ∏è –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:",
            chartInstance.id
          );
          chartInstance.destroy();
        }
      });

      let html = "";

      if (Object.keys(buyerGroupsData).length > 0) {
        html += `
          <div class="buyer-group-main-section">
            <h2 class="buyer-group-main-title">
              <i class="fas fa-sitemap"></i>
              –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–µ–¥–∏–∞–±–∞–π–µ—Ä–∞–º
            </h2>
            <div class="buyer-group-main-subtitle">
              –ü–æ–ª–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –ë–∞–π–µ—Ä ‚Üí –ì—Ä—É–ø–ø—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
            </div>
          </div>
        `;

        Object.keys(buyerGroupsData).forEach((buyerName, buyerIndex) => {
          const buyerData = buyerGroupsData[buyerName];

          // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –±–∞–π–µ—Ä–∞
          let cleanBuyerName = String(buyerName || `buyer_${buyerIndex}`)
            .replace(/[^a-zA-Z0-9]/g, "_")
            .replace(/_+/g, "_")
            .replace(/^_|_$/g, ""); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ

          // –ï—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
          if (!cleanBuyerName) {
            cleanBuyerName = `buyer_${buyerIndex}`;
          }

          const buyerId = `enhanced_buyer_${cleanBuyerName}`;
          const groupsCount = Object.keys(buyerData.groups || {}).length;
          const buyerChartId = `buyer_chart_${buyerId}`;

          console.log(
            "üîç Buyer name:",
            buyerName,
            "-> Clean name:",
            cleanBuyerName,
            "-> ID:",
            buyerId
          );

          html += `
            <div class="buyer-group-section">
              <div class="buyer-header-enhanced" onclick="toggleBuyerGroup('${buyerId}')">
                <div class="buyer-info-grid">
                  <div class="buyer-main-info">
                    <h2>
                      <i class="fas fa-user-tie"></i>
                      ${escapeHtml(buyerName)}
                    </h2>
                    <p>–ú–µ–¥–∏–∞–±–∞–π–µ—Ä ‚Ä¢ ${groupsCount} ${groupsCount === 1
              ? "–≥—Ä—É–ø–ø–∞"
              : groupsCount < 5
                ? "–≥—Ä—É–ø–ø—ã"
                : "–≥—Ä—É–ø–ø"
            } –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>
                  </div>
                  <div class="buyer-toggle-section">
                    ${buyerData.buyerData
              ? `
                      <div class="buyer-stats-preview">
                        ${buyerData.buyerData.metrics.activeDays} –¥–Ω–µ–π ‚Ä¢ CR ${buyerData.buyerData.metrics.cr}
                      </div>
                    `
              : ""
            }
                    <button class="buyer-toggle-btn collapsed" type="button">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="buyer-content-area collapsed" id="${buyerId}_content">
                
                ${buyerData.buyerData
              ? `
                  <div class="buyer-metrics-section">
                    <h3 class="buyer-metrics-title">
                      <i class="fas fa-chart-pie"></i>
                      –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –±–∞–π–µ—Ä–∞
                    </h3>
                    <div class="buyer-metrics-grid">
                      ${generateEnhancedBuyerMetrics(
                buyerData.buyerData.metrics
              )}
                    </div>
                  </div>
                  
                  <div class="buyer-chart-section">
                    <h3 class="buyer-chart-title">
                      <i class="fas fa-chart-line"></i>
                      –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –±–∞–π–µ—Ä–∞
                    </h3>
                    <div class="buyer-chart-container">
                      <canvas id="${buyerChartId}"></canvas>
                    </div>
                  </div>
                  
                  <div class="buyer-chart-section">
                    <h3 class="buyer-chart-title">
                      <i class="fas fa-table"></i>
                      –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–∞–π–µ—Ä–∞
                    </h3>
                    <div style="background: white; border-radius: 12px; padding: 20px;">
                      <div class="table-container">
                        <table class="data-table" id="buyer_table_${buyerId}"></table>
                      </div>
                    </div>
                  </div>
                `
              : ""
            }
                
                <div class="buyer-groups-section">
                  <h3 class="buyer-groups-title">
                    <i class="fas fa-folder-tree"></i>
                    –ì—Ä—É–ø–ø—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π (${groupsCount})
                  </h3>
                  
                  ${Object.keys(buyerData.groups || {})
              .map((groupName, groupIndex) => {
                const groupData = buyerData.groups[groupName];
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
                let cleanGroupName = String(
                  groupName || `group_${groupIndex}`
                )
                  .replace(/[^a-zA-Z0-9]/g, "_")
                  .replace(/_+/g, "_")
                  .replace(/^_|_$/g, ""); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ

                // –ï—Å–ª–∏ –∏–º—è –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
                if (!cleanGroupName) {
                  cleanGroupName = `group_${groupIndex}`;
                }

                const nestedGroupId = `enhanced_group_${cleanBuyerName}_${cleanGroupName}_${groupIndex}`;

                console.log(
                  "üîç Group name:",
                  groupName,
                  "-> Clean name:",
                  cleanGroupName,
                  "-> ID:",
                  nestedGroupId
                );
                const chartId = `chart_${nestedGroupId}`;
                const tableId = `table_${nestedGroupId}`;

                return `
                      <div class="nested-group-enhanced">
                        <div class="nested-group-header-enhanced" onclick="toggleNestedGroup('${nestedGroupId}')">
                          <div class="nested-group-info-grid">
                            <div class="nested-group-main-info">
                              <h3>
                                <i class="fas fa-folder"></i>
                                ${escapeHtml(groupName)}
                              </h3>
                              <p>–ì—Ä—É–ø–ø–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π ‚Ä¢ ${groupData.metrics.activeDays
                  } –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π ‚Ä¢ CR ${groupData.metrics.cr}</p>
                            </div>
                            <div class="buyer-toggle-section">
                              <div class="buyer-stats-preview">
                                ${groupData.metrics.videos} –≤–∏–¥–µ–æ ‚Ä¢ ${groupData.metrics.sites
                  } –ª–µ–Ω–¥–∏–Ω–≥–æ–≤
                              </div>
                              <button class="buyer-toggle-btn collapsed" type="button">
                                <i class="fas fa-chevron-right"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                        
                        <div class="nested-group-content-enhanced collapsed" id="${nestedGroupId}_content">
                          
                          <div class="nested-group-metrics">
                            <h4 class="nested-group-metrics-title">
                              <i class="fas fa-chart-bar"></i>
                              –ú–µ—Ç—Ä–∏–∫–∏ –≥—Ä—É–ø–ø—ã
                            </h4>
                            <div class="nested-group-metrics-grid">
                              ${generateEnhancedGroupMetrics(groupData.metrics)}
                            </div>
                          </div>
                          
                          <div class="nested-group-chart">
                            <h4 class="nested-group-chart-title">
                              <i class="fas fa-chart-area"></i>
                              –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏
                            </h4>
                            <div class="nested-group-chart-container">
                              <canvas id="${chartId}"></canvas>
                            </div>
                          </div>
                          
                          <div class="nested-group-table">
                            <h4 class="nested-group-table-title">
                              <i class="fas fa-table"></i>
                              –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                            </h4>
                            <div class="table-container">
                              <table class="data-table" id="${tableId}"></table>
                            </div>
                          </div>
                          
                        </div>
                      </div>
                    `;
              })
              .join("")}
                  
                </div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        console.log("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:");
        const allCanvases = container.querySelectorAll("canvas");
        const allTables = container.querySelectorAll("table");
        console.log("üîç Canvas —ç–ª–µ–º–µ–Ω—Ç–æ–≤:", allCanvases.length);
        console.log("üîç Table —ç–ª–µ–º–µ–Ω—Ç–æ–≤:", allTables.length);
        allCanvases.forEach((canvas) =>
          console.log("üîç Canvas ID:", canvas.id)
        );
        allTables.forEach((table) => console.log("üîç Table ID:", table.id));

        // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
          console.log("üìä –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —á–µ—Ä–µ–∑ 100–º—Å");

          // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Å –∑–∞–º—ã–∫–∞–Ω–∏—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–π–µ—Ä–∞
          Object.keys(buyerGroupsData).forEach((buyerName, buyerIndex) => {
            const buyerData = buyerGroupsData[buyerName];

            // –¢–∞–∫–∞—è –∂–µ –ª–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–∞–∫ –≤ HTML
            let cleanBuyerName = String(buyerName || `buyer_${buyerIndex}`)
              .replace(/[^a-zA-Z0-9]/g, "_")
              .replace(/_+/g, "_")
              .replace(/^_|_$/g, "");

            if (!cleanBuyerName) {
              cleanBuyerName = `buyer_${buyerIndex}`;
            }

            const buyerId = `enhanced_buyer_${cleanBuyerName}`;
            const buyerChartId = `buyer_chart_${buyerId}`;
            const buyerTableId = `buyer_table_${buyerId}`;

            console.log(
              "üìä –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –±–∞–π–µ—Ä–∞:",
              buyerName,
              "ChartID:",
              buyerChartId,
              "TableID:",
              buyerTableId
            );

            // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –∑–∞–º—ã–∫–∞–Ω–∏–µ–º –¥–ª—è –±–∞–π–µ—Ä–∞
            (function (bName, bData, bChartId, bTableId) {
              if (bData.buyerData) {
                console.log("üìä –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –±–∞–π–µ—Ä–∞:", bName);
                displaySegmentChart(
                  bChartId,
                  article,
                  bName,
                  bData.buyerData.data
                );
                displaySegmentTable(bTableId, bData.buyerData.data, "buyer");
              }
            })(buyerName, buyerData, buyerChartId, buyerTableId);

            // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Å –∑–∞–º—ã–∫–∞–Ω–∏—è–º–∏ –¥–ª—è –≥—Ä—É–ø–ø
            Object.keys(buyerData.groups || {}).forEach(
              (groupName, groupIndex) => {
                const groupData = buyerData.groups[groupName];

                // –¢–∞–∫–∞—è –∂–µ –ª–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–∞–∫ –≤ HTML
                let cleanGroupName = String(
                  groupName || `group_${groupIndex}`
                )
                  .replace(/[^a-zA-Z0-9]/g, "_")
                  .replace(/_+/g, "_")
                  .replace(/^_|_$/g, "");

                if (!cleanGroupName) {
                  cleanGroupName = `group_${groupIndex}`;
                }

                const nestedGroupId = `enhanced_group_${cleanBuyerName}_${cleanGroupName}_${groupIndex}`;
                const chartId = `chart_${nestedGroupId}`;
                const tableId = `table_${nestedGroupId}`;

                console.log(
                  "üìä –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø—ã:",
                  groupName,
                  "–±–∞–π–µ—Ä–∞:",
                  buyerName,
                  "ChartID:",
                  chartId,
                  "TableID:",
                  tableId
                );

                // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –∑–∞–º—ã–∫–∞–Ω–∏–µ–º –¥–ª—è –≥—Ä—É–ø–ø—ã
                (function (gName, gData, gChartId, gTableId, bName) {
                  console.log(
                    "üìä –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –≥—Ä—É–ø–ø—ã:",
                    gName,
                    "–±–∞–π–µ—Ä–∞:",
                    bName
                  );
                  displaySegmentTable(gTableId, gData.data, "group");
                  displaySegmentChart(
                    gChartId,
                    article,
                    `${bName} ‚Üí ${gName}`,
                    gData.data
                  );
                })(groupName, groupData, chartId, tableId, buyerName);
              }
            );
          });
        }, 100);
      } else {
        container.innerHTML = `
          <div class="buyer-group-main-section">
            <h2 class="buyer-group-main-title">
              <i class="fas fa-sitemap"></i>
              –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–µ–¥–∏–∞–±–∞–π–µ—Ä–∞–º
            </h2>
            <div class="buyer-group-main-subtitle">
              –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ –∏ –ø–µ—Ä–∏–æ–¥–∞
            </div>
          </div>
        `;
      }
    }

    function generateEnhancedBuyerMetrics(metrics) {
      return `
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">–¥–Ω–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–î–Ω–µ–π –≤ –Ω–æ—Ä–º–µ</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç CPL</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–ü—Ä–µ–≤—ã—à–µ–Ω–∏–π</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">–¥–Ω–µ–π –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">—Å—Ä–µ–¥–Ω–∏–π CR</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–í–∏–¥–µ–æ</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–õ–µ–Ω–¥–∏–Ω–≥–∏</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">–ø–æ—Å–∞–¥–æ—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü</div>
        </div>
      `;
    }

    function generateEnhancedGroupMetrics(metrics) {
      return `
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π</div>
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
          </div>
          <div class="metric-value">${metrics.activeDays}</div>
          <div class="metric-subtitle">–¥–Ω–µ–π —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–î–Ω–µ–π –≤ –Ω–æ—Ä–º–µ</div>
            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysInNorm}</div>
          <div class="metric-subtitle">—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç CPL</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–ü—Ä–µ–≤—ã—à–µ–Ω–∏–π</div>
            <div class="metric-icon"><i class="fas fa-exclamation-triangle"></i></div>
          </div>
          <div class="metric-value">${metrics.daysBelowAllowed}</div>
          <div class="metric-subtitle">–¥–Ω–µ–π –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
          </div>
          <div class="metric-value">${metrics.cr}</div>
          <div class="metric-subtitle">CR –≥—Ä—É–ø–ø—ã</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–í–∏–¥–µ–æ</div>
            <div class="metric-icon"><i class="fas fa-video"></i></div>
          </div>
          <div class="metric-value">${metrics.videos}</div>
          <div class="metric-subtitle">–∫—Ä–µ–∞—Ç–∏–≤–æ–≤</div>
        </div>
        
        <div class="metric-card-enhanced">
          <div class="metric-header">
            <div class="metric-label">–õ–µ–Ω–¥–∏–Ω–≥–∏</div>
            <div class="metric-icon"><i class="fas fa-globe"></i></div>
          </div>
          <div class="metric-value">${metrics.sites}</div>
          <div class="metric-subtitle">—Å—Ç—Ä–∞–Ω–∏—Ü</div>
        </div>
      `;
    }

    function displaySegmentTable(tableId, data, segmentType = "group") {
      console.log(`üìã –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É ${tableId} —Å –¥–∞–Ω–Ω—ã–º–∏:`, data);
      console.log(
        `üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ budget –≤ –¥–∞–Ω–Ω—ã—Ö:`,
        data.budget ? "–ï–°–¢–¨" : "–ù–ï–¢"
      );
      console.log(
        `üìã –ü–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π budget:`,
        data.budget ? data.budget.slice(0, 3) : "undefined"
      );
      console.log(`üìã –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å ID: "${tableId}"`);

      const table = document.getElementById(tableId);
      if (!table) {
        console.error(`‚ùå –¢–∞–±–ª–∏—Ü–∞ —Å ID ${tableId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
        console.log(
          "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å table:",
          document.querySelectorAll('table[id*="table"]')
        );
        return;
      }

      console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞:", table);

      const rows =
        segmentType === "buyer"
          ? [
            "–î–∞—Ç–∞",
            "–†–µ–π—Ç–∏–Ω–≥",
            "CPL (–¥–µ–Ω—å)",
            "–õ–∏–¥—ã (–¥–µ–Ω—å)",
            "–†–∞—Å—Ö–æ–¥ (–¥–µ–Ω—å)",
            "–ö–æ–Ω–≤–µ—Ä—Ç –≤ –¥–µ–Ω—å",
            "Max CPL (ROI +20%)",
            "CPL —Å —É—á—ë—Ç–æ–º —Å–±—Ä–æ—Å–æ–≤",
            "–ì—Ä—É–ø–ø—ã",
            "–î–æ–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π",
            "CTR",
            "CPM",
            "CPC",
            "–î–æ–ª—è –ø–æ–∫–∞–∑–æ–≤",
            "–ü–æ–∫–∞–∑—ã",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",
            "–ö–ª–∏–∫–∏",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 25% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 50% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 75% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
            "–í–∏–¥–µ–æ—Ä–æ–ª–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é",
            "–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ",
            "URL —Å–∞–π—Ç–∞",
            "–®–∞–±–ª–æ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è",
          ]
          : [
            "–î–∞—Ç–∞",
            "–†–µ–π—Ç–∏–Ω–≥",
            "CPL (–¥–µ–Ω—å)",
            "–õ–∏–¥—ã (–¥–µ–Ω—å)",
            "–†–∞—Å—Ö–æ–¥ (–¥–µ–Ω—å)",
            "–ö–æ–Ω–≤–µ—Ä—Ç –≤ –¥–µ–Ω—å",
            "Max CPL (ROI +20%)",
            "CPL —Å —É—á—ë—Ç–æ–º —Å–±—Ä–æ—Å–æ–≤",
            "–î–æ–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π",
            "CTR",
            "CPM",
            "CPC",
            "–î–æ–ª—è –ø–æ–∫–∞–∑–æ–≤",
            "–ü–æ–∫–∞–∑—ã",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä—ã",
            "–ö–ª–∏–∫–∏",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 25% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 50% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
            "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ 75% –≤–∏–¥–µ–æ—Ä–æ–ª–∏–∫–∞",
            "–í–∏–¥–µ–æ—Ä–æ–ª–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é",
            "–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ",
            "URL —Å–∞–π—Ç–∞",
            "–®–∞–±–ª–æ–Ω –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è",
          ];

      let html = "<tbody>";

      rows.forEach((rowName, index) => {
        html += `<tr><td class="metric-row" style="min-width: 220px;">${rowName}</td>`;
        for (let i = 0; i < data.dates.length; i++) {
          let value = "";
          let className = "";
          let cellStyle = "";

          if (segmentType === "buyer") {
            switch (index) {
              case 0:
                value = data.dates[i];
                break;
              case 1:
                value = data.ratings[i];
                className = value ? `rating-${value}` : "";
                break;
              case 2:
                value = formatNumberWithZero(data.cplDay[i]);
                break;
              case 3:
                value = data.leadsDay[i];
                break;
              case 4:
                value = formatNumberWithZero(data.spendDay[i]);
                break;
              case 5:
                value = data.conversionDay ? data.conversionDay[i] : "";
                break;
              case 6:
                value = formatNumber(data.maxCPL ? data.maxCPL[i] : "");
                break;
              case 7:
                value = formatNumberWithZero(
                  data.cplCumulative ? data.cplCumulative[i] : 0
                );
                if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                  value += " " + data.cplCumulativeArrows[i];
                }
                if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                  const color = data.cplCumulativeColors[i];
                  if (color === "green") {
                    cellStyle =
                      "background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;";
                  } else if (color === "red") {
                    cellStyle =
                      "background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;";
                  } else if (color === "gray") {
                    cellStyle =
                      "background-color: #f3f4f6 !important; color: #6b7280 !important;";
                  }
                }
                break;
              case 8:
                value = data.groups ? data.groups[i] : "";
                break;
              case 9:
                value = data.engagementRate ? data.engagementRate[i] : "";
                break;
              case 10:
                value = data.ctr ? data.ctr[i] : "";
                break;
              case 11:
                value = data.cpm ? data.cpm[i] : "";
                break;
              case 12:
                value = data.cpc ? data.cpc[i] : "";
                break;
              case 13:
                value = data.engagementView ? data.engagementView[i] : "";
                break;
              case 14:
                value = data.showed ? data.showed[i] : "";
                break;
              case 15:
                value = data.viewed ? data.viewed[i] : "";
                break;
              case 16:
                value = data.linkClicks ? data.linkClicks[i] : "";
                break;
              case 17:
                value = data.videoStart ? data.videoStart[i] : "";
                break;
              case 18:
                value = data.videoHalf ? data.videoHalf[i] : "";
                break;
              case 19:
                value = data.videoAlmost ? data.videoAlmost[i] : "";
                break;
              case 20:
                value = data.videoFull ? data.videoFull[i] : "";
                break;
              case 21:
                value = data.videoName ? data.videoName[i] : "";
                break;
              case 22:
                const urlValue = data.siteUrl ? data.siteUrl[i] : "";
                value = makeUrlsClickable(urlValue);
                break;
              case 23:
                value = data.trackTemplate ? data.trackTemplate[i] : "";
                break;
            }
          } else {
            switch (index) {
              case 0:
                value = data.dates[i];
                break;
              case 1:
                value = data.ratings[i];
                className = value ? `rating-${value}` : "";
                break;
              case 2:
                value = formatNumberWithZero(data.cplDay[i]);
                break;
              case 3:
                value = data.leadsDay[i];
                break;
              case 4:
                value = formatNumberWithZero(data.spendDay[i]);
                break;
              case 5:
                value = data.conversionDay ? data.conversionDay[i] : "";
                break;
              case 6:
                value = formatNumber(data.maxCPL ? data.maxCPL[i] : "");
                break;
              case 7:
                value = formatNumberWithZero(
                  data.cplCumulative ? data.cplCumulative[i] : 0
                );
                if (data.cplCumulativeArrows && data.cplCumulativeArrows[i]) {
                  value += " " + data.cplCumulativeArrows[i];
                }
                if (data.cplCumulativeColors && data.cplCumulativeColors[i]) {
                  const color = data.cplCumulativeColors[i];
                  if (color === "green") {
                    cellStyle =
                      "background-color: #dcfce7 !important; color: #166534 !important; font-weight: bold;";
                  } else if (color === "red") {
                    cellStyle =
                      "background-color: #fecaca !important; color: #dc2626 !important; font-weight: bold;";
                  } else if (color === "gray") {
                    cellStyle =
                      "background-color: #f3f4f6 !important; color: #6b7280 !important;";
                  }
                }
                break;
              case 8:
                value = data.engagementRate ? data.engagementRate[i] : "";
                break;
              case 9:
                value = data.ctr ? data.ctr[i] : "";
                break;
              case 10:
                value = data.cpm ? data.cpm[i] : "";
                break;
              case 11:
                value = data.cpc ? data.cpc[i] : "";
                break;
              case 12:
                value = data.engagementView ? data.engagementView[i] : "";
                break;
              case 13:
                value = data.showed ? data.showed[i] : "";
                break;
              case 14:
                value = data.viewed ? data.viewed[i] : "";
                break;
              case 15:
                value = data.linkClicks ? data.linkClicks[i] : "";
                break;
              case 16:
                value = data.videoStart ? data.videoStart[i] : "";
                break;
              case 17:
                value = data.videoHalf ? data.videoHalf[i] : "";
                break;
              case 18:
                value = data.videoAlmost ? data.videoAlmost[i] : "";
                break;
              case 19:
                value = data.videoFull ? data.videoFull[i] : "";
                break;
              case 20:
                value = data.videoName ? data.videoName[i] : "";
                break;
              case 21:
                const urlValue = data.siteUrl ? data.siteUrl[i] : "";
                value = makeUrlsClickable(urlValue);
                break;
              case 22:
                value = data.trackTemplate ? data.trackTemplate[i] : "";
                break;
            }
          }

          const colClass =
            data.columnClasses && data.columnClasses[i]
              ? data.columnClasses[i]
              : "normal-spend";
          className += ` ${colClass}`;

          // –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω—É–ª–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
          let additionalStyle = "";
          if (colClass.includes("zero-spend")) {
            additionalStyle = " text-align: center;";
          }

          if (
            (segmentType === "buyer" && index === 22) ||
            (segmentType === "group" && index === 21)
          ) {
            html += `<td class="${className} url-cell" style="${cellStyle}${additionalStyle}">${value}</td>`;
          } else {
            html += `<td class="${className}" style="${cellStyle}${additionalStyle}">${escapeHtml(
              value
            )}</td>`;
          }
        }
        html += "</tr>";
      });

      html += "</tbody>";
      table.innerHTML = html;
    }

    function displaySegmentChart(chartId, article, segmentName, data) {
      console.log("üìä –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è:", chartId, segmentName);
      console.log("üìä –ò—â–µ–º canvas —Å ID:", chartId);

      const canvas = document.getElementById(chartId);
      if (!canvas) {
        console.error("‚ùå Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω:", chartId);
        console.log(
          "üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ canvas:",
          document.querySelectorAll('canvas[id*="chart"]')
        );
        return;
      }

      console.log("‚úÖ Canvas –Ω–∞–π–¥–µ–Ω:", canvas);

      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        console.log("üóëÔ∏è –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥—Ä–∞—Ñ–∏–∫:", existingChart.id);
        existingChart.destroy();
      }

      const ctx = canvas.getContext("2d");

      const gradientCPL = ctx.createLinearGradient(0, 0, 0, 400);
      gradientCPL.addColorStop(0, "rgba(99, 102, 241, 0.3)");
      gradientCPL.addColorStop(0.5, "rgba(99, 102, 241, 0.15)");
      gradientCPL.addColorStop(1, "rgba(99, 102, 241, 0.05)");

      const gradientLeads = ctx.createLinearGradient(0, 0, 0, 400);
      gradientLeads.addColorStop(0, "rgba(34, 197, 94, 0.25)");
      gradientLeads.addColorStop(1, "rgba(34, 197, 94, 0.05)");

      const gradientSpend = ctx.createLinearGradient(0, 0, 0, 400);
      gradientSpend.addColorStop(0, "rgba(251, 146, 60, 0.25)");
      gradientSpend.addColorStop(1, "rgba(251, 146, 60, 0.05)");

      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.dates,
          datasets: [
            {
              label: "CPL –∑–∞ –¥–µ–Ω—å",
              data: data.cplDay,
              borderColor: "#6366f1",
              backgroundColor: gradientCPL,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 8,
              pointBackgroundColor: "#6366f1",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 3,
              tension: 0,
              fill: true,
              order: 1,
            },
            {
              label: "–õ–∏–¥—ã –∑–∞ –¥–µ–Ω—å",
              data: data.leadsDay,
              borderColor: "#22c55e",
              backgroundColor: gradientLeads,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: "#22c55e",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: "y1",
              order: 2,
            },
            {
              label: "–†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å",
              data: data.spendDay,
              borderColor: "#fb923c",
              backgroundColor: gradientSpend,
              borderWidth: 3,
              pointRadius: 0,
              pointHoverRadius: 7,
              pointBackgroundColor: "#fb923c",
              pointBorderColor: "#ffffff",
              pointBorderWidth: 2,
              tension: 0,
              yAxisID: "y1",
              order: 3,
            },
            {
              label: "Max CPL (–Ω–æ—Ä–º–∞)",
              data: data.maxCPL || [],
              borderColor: "#dc2626",
              backgroundColor: "transparent",
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderDash: [10, 5],
              tension: 0,
              order: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: "index",
          },
          plugins: {
            title: {
              display: true,
              text: `üìä ${article} - ${segmentName}`,
              font: {
                size: 20,
                weight: "bold",
              },
              color: "#1e293b",
            },
            legend: {
              display: true,
              position: "top",
            },
            tooltip: {
              backgroundColor: "rgba(15, 23, 42, 0.95)",
              titleColor: "#ffffff",
              bodyColor: "#e2e8f0",
              borderColor: "#475569",
              borderWidth: 1,
              cornerRadius: 12,
            },
          },
          scales: {
            x: {
              grid: {
                color: "rgba(148, 163, 184, 0.15)",
                drawBorder: false,
              },
              ticks: {
                color: "#64748b",
              },
            },
            y: {
              type: "linear",
              display: true,
              position: "left",
              title: {
                display: true,
                text: "üí∞ CPL ($)",
                color: "#374151",
              },
              grid: {
                color: "rgba(148, 163, 184, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#64748b",
                callback: function (value) {
                  return "$" + value.toFixed(1);
                },
              },
            },
            y1: {
              type: "linear",
              display: true,
              position: "right",
              title: {
                display: true,
                text: "üìà –õ–∏–¥—ã / –†–∞—Å—Ö–æ–¥",
                color: "#374151",
              },
              grid: {
                drawOnChartArea: false,
              },
              ticks: {
                color: "#64748b",
                callback: function (value) {
                  return Math.round(value);
                },
              },
            },
          },
        },
      });

      currentCharts.push(chart);
    }

    function formatNumber(value) {
      if (
        value === 0 ||
        value === "" ||
        value === null ||
        value === undefined
      )
        return "";
      const num = Number(value);
      if (isNaN(num)) return value;
      return num.toFixed(2).replace(".", ",");
    }

    function formatNumberWithZero(value) {
      if (value === null || value === undefined || value === "")
        return "0,00";
      const num = Number(value);
      if (isNaN(num)) return value;
      return num.toFixed(2).replace(".", ",");
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return "";
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ tooltip
    let activeTooltip = null;

    function showTooltip(tooltipId, event) {
      const tooltip = document.getElementById(tooltipId);
      if (!tooltip) return;

      // –°–∫—Ä—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π tooltip –µ—Å–ª–∏ –µ—Å—Ç—å
      if (activeTooltip && activeTooltip !== tooltip) {
        hideTooltip(activeTooltip.id);
      }

      activeTooltip = tooltip;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip
      tooltip.classList.add("show");

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º tooltip
      positionTooltip(tooltip, event);
    }

    function hideTooltip(tooltipId) {
      const tooltip = document.getElementById(tooltipId);
      if (!tooltip) return;

      tooltip.classList.remove("show", "pinned");
      if (activeTooltip === tooltip) {
        activeTooltip = null;
      }
    }

    function pinTooltip(tooltipId, event) {
      const tooltip = document.getElementById(tooltipId);
      if (!tooltip) return;

      // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ tooltip
      document.querySelectorAll(".tooltip.pinned").forEach((t) => {
        if (t !== tooltip) {
          t.classList.remove("show", "pinned");
        }
      });

      activeTooltip = tooltip;
      tooltip.classList.add("show", "pinned");

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º tooltip
      positionTooltip(tooltip, event);
    }

    function positionTooltip(tooltip, event) {
      const rect = event.currentTarget.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();
      const viewport = {
        width: window.innerWidth,
        height: window.innerHeight,
      };

      let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
      let top = rect.top - tooltipRect.height - 20;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
      if (left < 10) left = 10;
      if (left + tooltipRect.width > viewport.width - 10) {
        left = viewport.width - tooltipRect.width - 10;
      }

      if (top < 10) {
        top = rect.bottom + 20;
        tooltip.style.transform = "none";
        tooltip.querySelector("::after")?.style.setProperty("top", "-10px");
        tooltip.querySelector("::after")?.style.setProperty("bottom", "auto");
      }

      tooltip.style.left = left + "px";
      tooltip.style.top = top + "px";
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ tooltip
    function setupTooltipHandlers() {
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      document.removeEventListener("click", handleDocumentClick);

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ tooltip-container
      document.querySelectorAll(".tooltip-container").forEach((container) => {
        const tooltipType = container.dataset.tooltip;
        const tooltipId = `tooltip-${tooltipType}`;

        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        container.replaceWith(container.cloneNode(true));

        // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const newContainer = document.querySelector(
          `[data-tooltip="${tooltipType}"]`
        );

        // Hover –¥–ª—è –ø–æ–∫–∞–∑–∞
        newContainer.addEventListener("mouseenter", (e) => {
          if (
            !document.getElementById(tooltipId).classList.contains("pinned")
          ) {
            showTooltip(tooltipId, e);
          }
        });

        // –ö–ª–∏–∫ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏
        newContainer.addEventListener("click", (e) => {
          e.stopPropagation();
          pinTooltip(tooltipId, e);
        });

        // –°–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏ (–µ—Å–ª–∏ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω)
        newContainer.addEventListener("mouseleave", () => {
          const tooltip = document.getElementById(tooltipId);
          if (tooltip && !tooltip.classList.contains("pinned")) {
            setTimeout(() => {
              if (!tooltip.classList.contains("pinned")) {
                hideTooltip(tooltipId);
              }
            }, 300);
          }
        });
      });

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö tooltip
      document.addEventListener("click", handleDocumentClick);
    }

    function handleDocumentClick(e) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –ø–æ tooltip –∏–ª–∏ –µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
      if (
        !e.target.closest(".tooltip-container") &&
        !e.target.closest(".tooltip")
      ) {
        document.querySelectorAll(".tooltip.pinned").forEach((tooltip) => {
          hideTooltip(tooltip.id);
        });
      }
    }

    window.showTooltip = showTooltip;
    window.hideTooltip = hideTooltip;
    window.pinTooltip = pinTooltip;
    window.setupTooltipHandlers = setupTooltipHandlers;
  </script>
</body>

</html>
